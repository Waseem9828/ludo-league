
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========= Helper Functions =========
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return request.auth != null && request.auth.token.role == 'superAdmin';
    }
    function isKycAdmin() {
      return request.auth != null && (request.auth.token.role == 'kycAdmin' || isSuperAdmin());
    }
    function isDepositAdmin() {
      return request.auth != null && (request.auth.token.role == 'depositAdmin' || isSuperAdmin());
    }
    function isWithdrawalAdmin() {
      return request.auth != null && (request.auth.token.role == 'withdrawalAdmin' || isSuperAdmin());
    }
    function isMatchAdmin() {
      return request.auth != null && (request.auth.token.role == 'matchAdmin' || isSuperAdmin());
    }
    // General admin for read-only access to some collections, or for less sensitive writes.
    function isAdmin() {
        return request.auth != null && request.auth.token.admin == true;
    }

    // ========= User-specific Rules =========
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update: if isOwner(userId) || isSuperAdmin(); // Super admin can edit profiles
    }
    
    match /users/{userId}/activity/{logId} {
        allow read: if isOwner(userId) || isAdmin();
    }
    
    match /roomCodeCreators/{userId} {
        allow read, create, delete: if isOwner(userId);
        allow list: if request.auth != null;
    }
    match /roomCodeSeekers/{userId} {
        allow read, create, delete: if isOwner(userId);
        allow list: if request.auth != null;
    }

    // ========= Admin-specific Rules =========

    // KYC
    match /kycApplications/{kycId} {
      allow create: if isOwner(request.resource.data.userId); // User can create
      allow read: if isOwner(resource.data.userId) || isKycAdmin(); // Owner or KYC admin can read
      allow list, update: if isKycAdmin(); // Only KYC admin can list all and update
    }

    // Deposits
    match /depositRequests/{depositId} {
        allow create: if isOwner(request.resource.data.userId);
        allow get: if isOwner(resource.data.userId) || isDepositAdmin();
        allow list: if (request.auth.uid == request.query.where.userId) || isDepositAdmin();
        allow update: if isDepositAdmin();
    }

    // Withdrawals
    match /withdrawalRequests/{withdrawalId} {
        allow create: if isOwner(request.resource.data.userId);
        allow get: if isOwner(resource.data.userId) || isWithdrawalAdmin();
        allow list: if (request.auth.uid == request.query.where.userId) || isWithdrawalAdmin();
        allow update: if isWithdrawalAdmin();
    }
    
    // Matches & Results
    match /matches/{matchId} {
      allow read, list: if request.auth != null;
      allow create: if false; // By function
      // Player can update their own status, match admin can update for resolution
      allow update: if (request.auth != null && request.auth.uid in resource.data.playerIds) || isMatchAdmin();
    }
    match /matches/{matchId}/results/{userId} {
      // Only players in the match and match admins can read results
      allow read: if isMatchAdmin() || (request.auth != null && request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.playerIds);
      allow write: if isOwner(userId);
    }
    
    // Support Chat
    match /supportChats/{userId}/{path=**} {
      allow read, write: if isOwner(userId) || isSuperAdmin(); // For now, only superAdmins can act as support
    }

    // Transactions are read-only for users, created by functions. Admins can read all.
    match /transactions/{transactionId} {
        allow read: if isOwner(resource.data.userId) || isAdmin();
        allow create, update, delete: if false;
    }

    // Admin-only write collections
    match /adminLogs/{logId} { allow read, write: if isAdmin(); }
    match /tournaments/{doc=**} {
        allow read: if request.auth != null;
        allow write: if isMatchAdmin(); // Only Match Admins can create/update tournaments
    }
    match /news/{doc=**} {
        allow read: if request.auth != null;
        allow write: if isAdmin(); // Any admin can post news
    }
     match /announcements/{doc=**} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    match /banners/{doc=**} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    match /dashboardCardImages/{doc=**} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }
    match /tasks/{doc=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
     match /user_tasks/{userId}/tasks/{taskId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if false; // Function only
    }
    
    // Configuration collections, only superAdmins can write
    match /upiConfiguration/{configId} {
        allow read: if isDepositAdmin();
        allow write: if isSuperAdmin();
    }
    match /referralConfiguration/{doc=**} {
        allow read: if request.auth != null;
        allow write: if isSuperAdmin();
    }
    match /bonus_config/{doc=**} {
        allow read: if request.auth != null;
        allow write: if isSuperAdmin();
    }
    match /settings/global {
        allow get: if request.auth != null;
        allow write: if isSuperAdmin();
    }
    
    // Forum rules
    match /forumPosts/{postId} {
        allow read: if request.auth != null;
        allow create: if isOwner(request.resource.data.authorId);
        allow update: if (isOwner(resource.data.authorId)) || 
                       (request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount', 'lastReplyAt']));
        allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
    match /forumPosts/{postId}/replies/{replyId} {
      allow read: if request.auth != null;
      allow create: if isOwner(request.resource.data.authorId);
      allow update: if isOwner(resource.data.authorId) && request.resource.data.keys().hasOnly(['content']);
      allow delete: if isOwner(resource.data.authorId) || isAdmin();
    }
  }
}
