rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.role == 'superAdmin';
    }

    function isAnyAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isKycAdmin() {
      return isSuperAdmin() || (isSignedIn() && request.auth.token.role == 'kycAdmin');
    }

    function isDepositAdmin() {
      return isSuperAdmin() || (isSignedIn() && request.auth.token.role == 'depositAdmin');
    }

    function isWithdrawalAdmin() {
      return isSuperAdmin() || (isSignedIn() && request.auth.token.role == 'withdrawalAdmin');
    }

    function isMatchAdmin() {
      return isSuperAdmin() || (isSignedIn() && request.auth.token.role == 'matchAdmin');
    }

    // ===== Global & Public-Read Collections =====
    match /settings/global {
      allow get: if true;
      allow write: if isSuperAdmin();
    }

    match /announcements/{docId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }
    
    match /banners/{docId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    match /dashboardCardImages/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }

    match /news/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }

    match /tasks/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }
    
    match /tournaments/{tourneyId} {
        allow read: if isSignedIn();
        allow create, update: if isAnyAdmin(); 
        allow delete: if isSuperAdmin();
    }

    match /tournaments/{tourneyId}/{document=**} {
        allow read: if isSignedIn();
        allow write: if isAnyAdmin();
    }

    // ===== User Data =====
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && !('walletBalance' in request.resource.data) && !('isAdmin' in request.resource.data) && !('role' in request.resource.data) && !('kycStatus' in request.resource.data);
      allow update: if isAnyAdmin();
    }

    // ===== User-Specific Subcollections =====
    match /user_tasks/{userId}/{document=**} {
        allow read, write: if isOwner(userId) || isAnyAdmin();
    }

    match /supportChats/{userId}/{document=**} {
        allow read, write: if isOwner(userId) || isSuperAdmin();
    }
    
    // ===== Collections with User-Restricted List access =====
    match /kycApplications/{appId} {
      allow get: if isOwner(resource.data.userId) || isKycAdmin();
      allow list: if isKycAdmin() || (isSignedIn() && request.query.where.userId == request.auth.uid);
      allow create, update: if isOwner(request.resource.data.userId);
    }
    
    match /depositRequests/{reqId} {
       allow get: if isOwner(resource.data.userId) || isDepositAdmin();
       allow list: if isDepositAdmin() || (isSignedIn() && request.query.where.userId == request.auth.uid);
       allow write: if false; 
    }

    match /withdrawalRequests/{reqId} {
       allow get: if isOwner(resource.data.userId) || isWithdrawalAdmin();
       allow list: if isWithdrawalAdmin() || (isSignedIn() && request.query.where.userId == request.auth.uid);
       allow write: if false; 
    }
    
    match /transactions/{transId} {
       allow get: if isOwner(resource.data.userId) || isSuperAdmin();
       allow list: if isSuperAdmin() || (isSignedIn() && request.query.where.userId == request.auth.uid);
       allow write: if false;
    }
    
    // ===== Matches =====
    match /matches/{matchId} {
        allow read: if isSignedIn();
        allow create, update, delete: if false; // All writes through functions
    }
    
    match /matches/{matchId}/results/{userId} {
        allow read: if isOwner(userId) || isMatchAdmin();
        allow create, update: if isOwner(userId); 
    }

    // ===== Community Forum =====
    match /forumPosts/{postId} {
        allow read: if isSignedIn();
        allow create: if isOwner(request.resource.data.authorId);
        allow update: if isOwner(resource.data.authorId);
        allow delete: if isOwner(resource.data.authorId) || isSuperAdmin();
    }
    
    match /forumPosts/{postId}/replies/{replyId} {
        allow read: if isSignedIn();
        allow create: if isOwner(request.resource.data.authorId);
        allow update, delete: if isOwner(resource.data.authorId) || isSuperAdmin();
    }

    // ===== Admin-Only Config =====
    match /upiConfiguration/{docId} {
      allow read, write: if isSuperAdmin() || isDepositAdmin();
    }
    
    match /referralConfiguration/{docId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    match /bonus_config/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }
    
    match /matchCommission/{docId} {
        allow read: if isSignedIn();
        allow write: if isSuperAdmin();
    }
    
    // --- Collections only accessible by backend functions ---
    match /submittedUTRs/{utr} {
        allow read, write: if false;
    }

    match /adminLogs/{logId} {
        allow read: if isAnyAdmin();
        allow write: if false;
    }
  }
}
