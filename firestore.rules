
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSuperAdmin() {
      return request.auth.token.role == 'superAdmin';
    }
    function isAnyAdmin() {
      return request.auth.token.admin == true;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    function isPlayerInMatch(matchDoc) {
      return request.auth.uid in matchDoc.data.playerIds;
    }
    
    // ====================================
    //        USER DATA RULES
    // ====================================
    match /users/{userId} {
      // Anyone can read a user's public profile
      allow read: if request.auth != null;

      // A user can only create their own profile
      allow create: if isOwner(userId);

      // A user can update their own profile, but some fields are protected
      allow update: if isOwner(userId) &&
                     !('walletBalance' in request.resource.data) && 
                     !('trustScore' in request.resource.data) &&
                     !('isAdmin' in request.resource.data) &&
                     !('role' in request.resource.data);
                     
      // Admins can update user fields like 'role' or 'isBlocked'
      allow update: if isAnyAdmin();
    }

    // ====================================
    //        MATCH DATA RULES
    // ====================================
    match /matches/{matchId} {
      // Any authenticated user can view a match
      allow read: if request.auth != null;
      
      // Creating a match is handled by the 'createMatch' cloud function
      allow create: if false;

      // Updating a match has complex rules
      allow update: if 
        // A player can join a match that is 'OPEN'
        (request.resource.data.status == 'JOINED' && resource.data.status == 'OPEN' && isPlayerInMatch(resource)) ||
        // The creator can add a room code when the match is 'JOINED'
        (request.resource.data.status == 'PLAYING' && resource.data.status == 'JOINED' && isOwner(resource.data.creatorId)) ||
        // A player can submit their result
        (request.resource.data.status == 'RESULT_PENDING' && resource.data.status == 'PLAYING' && isPlayerInMatch(resource)) ||
        // The 'onMatchUpdate' function handles all other status changes
        (request.auth == null);
        
      // Nobody can delete a match directly; it must be cancelled
      allow delete: if false;
    }

    // ====================================
    //        TRANSACTION RULES
    // ====================================
    match /transactions/{transactionId} {
        // Users can only read their own transactions
        allow read: if isOwner(resource.data.userId) || isSuperAdmin();
        
        // Transactions are only created by backend functions
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
    
    // ====================================
    //        ADMIN & CONFIG RULES
    // ====================================
    match /matchCommission/{docId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }
    
    match /referralConfiguration/{docId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    // All other collections are admin-only by default
    match /{document=**} {
      allow read, write: if isAnyAdmin();
    }
  }
}
